<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Maker Bot — Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <!-- highlight.js -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js"></script>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #020617; /* slate-950 */
            --panel-bg: rgba(15, 23, 42, 0.6); /* slate-900/60 */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .monaco-container { width: 100%; height: 100%; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animations */
        @keyframes slideInUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-in { animation: slideInUp 0.3s ease-out forwards; }
        
        .toast { animation: slideInToast 0.3s ease, fadeOutToast 0.3s ease 2.7s forwards; }
        @keyframes slideInToast { from { transform: translateY(-20px) translateX(-50%); opacity:0; } to { transform: translateY(0) translateX(-50%); opacity:1; } }
        @keyframes fadeOutToast { to { opacity: 0; } }

        /* Typing Indicator */
        .typing-dot { animation: typingBounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typingBounce { 0%,80%,100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Chat Bubbles */
        .chat-msg-user { 
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); 
            border-radius: 18px 18px 2px 18px; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .chat-msg-bot { 
            background: rgba(30, 41, 59, 0.7); 
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(8px);
            border-radius: 18px 18px 18px 2px; 
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-header {
            background: rgba(2, 6, 23, 0.8);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .modal-backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }
        .resize-handle { cursor: row-resize; transition: background 0.2s; }
        .resize-handle:hover { background: #6366f1; } /* indigo-500 */
        
        pre code { background: transparent !important; padding: 0 !important; font-size: 13px; font-family: 'JetBrains Mono', monospace; }
        .icon { display: inline-block; vertical-align: middle; flex-shrink: 0; }
    </style>
</head>
<body class="h-full text-slate-300 overflow-hidden flex">

<!-- SVG Icons -->
<svg xmlns="http://www.w3.org/2000/svg" class="hidden">
  <symbol id="i-plus" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></symbol>
  <symbol id="i-x" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></symbol>
  <symbol id="i-settings" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></symbol>
  <symbol id="i-send" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></symbol>
  <symbol id="i-copy" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></symbol>
  <symbol id="i-download" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></symbol>
  <symbol id="i-play" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></symbol>
  <symbol id="i-stop" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></symbol>
  <symbol id="i-check-circle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></symbol>
  <symbol id="i-shield" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></symbol>
  <symbol id="i-refresh" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></symbol>
  <symbol id="i-trash" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></symbol>
  <symbol id="i-message" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></symbol>
  <symbol id="i-terminal" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"/><line x1="12" y1="19" x2="20" y2="19"/></symbol>
  <symbol id="i-code" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></symbol>
  <symbol id="i-clock" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></symbol>
  <symbol id="i-chevron-down" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></symbol>
  <symbol id="i-arrow-right" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></symbol>
  <symbol id="i-box" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></symbol>
  <symbol id="i-file-text" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></symbol>
  <symbol id="i-zap" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></symbol>
</svg>

<!-- Toast -->
<div id="toast-container" class="fixed top-6 left-1/2 transform -translate-x-1/2 z-50 space-y-2 pointer-events-none"></div>

<!-- Settings Modal -->
<div id="settings-modal" class="hidden fixed inset-0 z-40 modal-backdrop flex items-center justify-center p-4">
    <div class="glass-panel border border-slate-700/50 rounded-2xl w-full max-w-lg max-h-[85vh] overflow-y-auto shadow-2xl relative animate-slide-in">
        <div class="flex items-center justify-between px-6 py-5 border-b border-slate-700/50">
            <h2 class="text-lg font-semibold text-white flex items-center gap-2">
                <svg class="icon w-5 h-5 text-indigo-400"><use href="#i-settings"/></svg>
                Settings
            </h2>
            <button onclick="closeSettings()" class="text-slate-400 hover:text-white transition-colors bg-slate-800/50 hover:bg-slate-700/80 p-1.5 rounded-lg">
                <svg class="icon w-5 h-5"><use href="#i-x"/></svg>
            </button>
        </div>
        <div class="p-6 space-y-6">
            <!-- Provider -->
            <div>
                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">Provider</label>
                <div class="relative">
                    <select id="s-provider" class="w-full bg-slate-900/80 border border-slate-700/50 rounded-xl px-4 py-3 text-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none appearance-none transition-all">
                        <option value="huggingface">HuggingFace</option>
                        <option value="ollama">Ollama (local)</option>
                        <option value="openai-compatible">OpenAI-compatible</option>
                    </select>
                    <svg class="icon w-4 h-4 text-slate-500 absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none"><use href="#i-chevron-down"/></svg>
                </div>
            </div>
            
            <!-- Model -->
            <div>
                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">Model <span id="s-model-count" class="text-slate-600 text-[10px] ml-1"></span></label>
                <div class="flex gap-2">
                    <div class="flex-1 relative" id="model-dropdown-wrapper">
                        <input id="s-model-search" type="text" autocomplete="off"
                               class="w-full bg-slate-900/80 border border-slate-700/50 rounded-xl px-4 py-3 text-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none text-sm placeholder-slate-600 font-mono transition-all"
                               placeholder="Search or enter model ID..."
                               onfocus="showModelDropdown()" oninput="filterModels()">
                        <input id="s-model" type="hidden" value="">
                        <div id="s-model-list" class="hidden absolute z-50 mt-2 w-full bg-slate-900 border border-slate-700/50 rounded-xl max-h-60 overflow-y-auto shadow-2xl backdrop-blur-xl"></div>
                    </div>
                    <button onclick="refreshModels()" class="px-3.5 bg-slate-800/80 hover:bg-slate-700 hover:text-white border border-slate-700/50 rounded-xl text-slate-400 transition-all flex items-center justify-center" title="Refresh list">
                        <svg class="icon w-5 h-5"><use href="#i-refresh"/></svg>
                    </button>
                </div>
            </div>

            <!-- API URL -->
            <div>
                <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">API URL</label>
                <input id="s-api-url" type="text" class="w-full bg-slate-900/80 border border-slate-700/50 rounded-xl px-4 py-3 text-slate-200 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 focus:outline-none placeholder-slate-600 text-sm font-mono transition-all" placeholder="https://...">
            </div>

            <!-- Sliders & Inputs -->
            <div class="grid grid-cols-2 gap-6">
                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">Temperature: <span id="s-temp-val" class="text-indigo-400">0.2</span></label>
                    <input id="s-temperature" type="range" min="0" max="1" step="0.05" value="0.2" class="w-full h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-400 uppercase tracking-wider mb-2">Max Tokens</label>
                    <input id="s-max-tokens" type="number" min="256" max="65536" value="16384" class="w-full bg-slate-900/80 border border-slate-700/50 rounded-xl px-3 py-2 text-slate-200 focus:border-indigo-500 focus:outline-none text-sm text-center">
                </div>
            </div>

            <div class="p-4 bg-slate-900/40 rounded-xl border border-slate-700/30 grid grid-cols-2 gap-4">
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input id="s-docker" type="checkbox" class="w-5 h-5 rounded border-slate-600 text-indigo-500 focus:ring-offset-0 focus:ring-indigo-500/50 bg-slate-800">
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Docker Sandbox</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input id="s-venv" type="checkbox" checked class="w-5 h-5 rounded border-slate-600 text-indigo-500 focus:ring-offset-0 focus:ring-indigo-500/50 bg-slate-800">
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Venv Isolation</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input id="s-linting" type="checkbox" checked class="w-5 h-5 rounded border-slate-600 text-indigo-500 focus:ring-offset-0 focus:ring-indigo-500/50 bg-slate-800">
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Ruff Linting</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input id="s-security" type="checkbox" checked class="w-5 h-5 rounded border-slate-600 text-indigo-500 focus:ring-offset-0 focus:ring-indigo-500/50 bg-slate-800">
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Bandit Security</span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer group">
                    <input id="s-auto-deps" type="checkbox" class="w-5 h-5 rounded border-slate-600 text-indigo-500 focus:ring-offset-0 focus:ring-indigo-500/50 bg-slate-800">
                    <span class="text-sm text-slate-300 group-hover:text-white transition-colors">Auto-Install Deps</span>
                </label>
                <label class="flex items-center gap-3">
                    <span class="text-xs text-slate-500 uppercase">Timeout</span>
                    <input id="s-timeout" type="number" min="0" value="30" class="w-16 bg-slate-800 border-none rounded text-xs text-center text-slate-300 focus:ring-1 focus:ring-indigo-500/50">
                    <span class="text-xs text-slate-500">sec</span>
                </label>
            </div>
        </div>
        <div class="px-6 py-4 border-t border-slate-700/50 flex justify-end gap-3 bg-slate-900/30">
            <button onclick="closeSettings()" class="px-5 py-2.5 rounded-xl text-sm font-medium text-slate-400 hover:text-white hover:bg-slate-800 transition-all">Cancel</button>
            <button onclick="saveSettings()" class="px-6 py-2.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm font-semibold shadow-lg shadow-indigo-500/20 transition-all">Save Changes</button>
        </div>
    </div>
</div>

<!-- Main Layout -->
<div class="flex-1 flex min-h-0">

    <!-- LEFT SIDEBAR -->
    <aside class="w-[280px] glass-panel border-r-0 border-r-slate-800/50 flex flex-col flex-shrink-0 z-20">
        <!-- Brand -->
        <div class="h-16 flex items-center px-6 border-b border-white/5">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <svg class="icon w-5 h-5 text-white"><use href="#i-zap"/></svg>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-white tracking-wide">Maker Bot</h1>
                    <p class="text-[10px] text-indigo-400 font-medium uppercase tracking-wider">v0.3.0 Dashboard</p>
                </div>
            </div>
        </div>

        <!-- Sessions -->
        <div class="p-4 border-b border-white/5">
            <div class="flex items-center justify-between mb-2 px-2">
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Sessions</span>
                <button onclick="createSession()" class="text-indigo-400 hover:text-indigo-300 bg-indigo-500/10 hover:bg-indigo-500/20 p-1 rounded-md transition-colors" title="New Chat">
                    <svg class="icon w-4 h-4"><use href="#i-plus"/></svg>
                </button>
            </div>
            <div id="session-list" class="space-y-1 max-h-[25vh] overflow-y-auto pr-1">
                {% for s in sessions %}
                <div class="group flex items-center rounded-lg {% if s.id == active_session_id %}bg-slate-800/80 text-white{% else %}text-slate-400 hover:bg-slate-800/40 hover:text-slate-300{% endif %} transition-colors"
                     data-session-id="{{ s.id }}">
                    <button class="flex-1 text-left px-3 py-2 text-xs truncate" onclick="switchSession('{{ s.id }}')">
                        {{ s.name }}
                    </button>
                    <button class="opacity-0 group-hover:opacity-100 px-2 text-slate-500 hover:text-red-400 transition-opacity" onclick="deleteSession('{{ s.id }}')">
                        <svg class="icon w-3.5 h-3.5"><use href="#i-trash"/></svg>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Script History -->
        <div class="flex-1 flex flex-col min-h-0 p-4">
            <div class="flex items-center justify-between mb-2 px-2">
                <span class="text-xs font-semibold text-slate-500 uppercase tracking-wider">Generated Scripts</span>
            </div>
            <div id="history-list"
                 class="flex-1 overflow-y-auto pr-1 space-y-1"
                 hx-get="/api/history/html"
                 hx-trigger="load, every 15s, historyRefresh"
                 hx-swap="innerHTML">
                <!-- HTMX populated -->
            </div>
        </div>

        <!-- Footer Stats -->
        <div class="p-4 mt-auto border-t border-white/5 bg-slate-900/30">
            <div id="stats-panel" hx-get="/api/stats/html" hx-trigger="load, every 10s" hx-swap="innerHTML">
                 <!-- HTMX populated -->
            </div>
            <button onclick="openSettings()" class="w-full mt-4 flex items-center justify-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white text-xs font-medium rounded-lg transition-all border border-slate-700/50">
                <svg class="icon w-4 h-4"><use href="#i-settings"/></svg> Preferences
            </button>
        </div>
    </aside>

    <!-- CENTER: CHAT -->
    <main class="flex-1 flex flex-col min-w-0 bg-[#0B101E] relative z-10">
        <!-- Header -->
        <header class="glass-header h-16 px-6 flex items-center justify-between">
            <div class="flex items-center gap-4 text-xs">
                <div class="flex flex-col">
                    <span class="text-slate-500 font-medium">Provider</span>
                    <span class="text-indigo-400 font-semibold" id="header-provider">{{ provider }}</span>
                </div>
                <div class="h-6 w-px bg-slate-800"></div>
                <div class="flex flex-col">
                    <span class="text-slate-500 font-medium">Model</span>
                    <span class="text-slate-200 font-medium" id="header-model">{{ model }}</span>
                </div>
            </div>
            <div class="flex gap-2">
                {% if docker_enabled %}
                <span class="px-2.5 py-1 bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-md text-[10px] font-bold uppercase tracking-wide flex items-center gap-1.5">
                    <svg class="icon w-3 h-3"><use href="#i-box"/></svg> Docker
                </span>
                {% endif %}
                {% if venv_enabled %}
                 <span class="px-2.5 py-1 bg-green-500/10 text-green-400 border border-green-500/20 rounded-md text-[10px] font-bold uppercase tracking-wide">
                    VENV
                </span>
                {% endif %}
            </div>
        </header>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
            {% if messages.is_empty() %}
            <div id="chat-placeholder" class="flex flex-col items-center justify-center h-full text-slate-600 animate-slide-in">
                <div class="w-16 h-16 bg-slate-900 rounded-2xl flex items-center justify-center mb-4 shadow-xl shadow-black/20 border border-slate-800">
                    <svg class="icon w-8 h-8 text-indigo-500"><use href="#i-message"/></svg>
                </div>
                <h3 class="text-lg font-semibold text-slate-300">Ready to code?</h3>
                <p class="text-sm text-slate-500 mt-1 max-w-xs text-center">Describe the Python script you want to build, and I'll generate it for you.</p>
            </div>
            {% else %}
                {% for msg in messages %}
                    {% if msg.role == "user" %}
                    <div class="flex justify-end animate-slide-in">
                        <div class="chat-msg-user px-5 py-3.5 max-w-[70%] text-sm text-white font-medium shadow-lg leading-relaxed whitespace-pre-wrap">{{ msg.content }}</div>
                    </div>
                    {% else %}
                    <div class="flex justify-start animate-slide-in">
                        <div class="chat-msg-bot px-5 py-4 max-w-[85%] text-sm shadow-xl">
                            <pre class="overflow-x-auto custom-scrollbar"><code class="language-python rounded-lg">{{ msg.content }}</code></pre>
                            <div class="mt-3 pt-3 border-t border-white/5 flex justify-end">
                                <button onclick="loadCodeInEditor(this.closest('.chat-msg-bot').querySelector('code').textContent)"
                                        class="text-xs text-indigo-400 hover:text-indigo-300 font-medium flex items-center gap-1.5 transition-colors">
                                    Load in Editor <svg class="icon w-3.5 h-3.5"><use href="#i-arrow-right"/></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% endif %}
        </div>

        <!-- Input Area -->
        <div class="p-6 pt-2">
            <div class="glass-panel rounded-2xl p-2 border border-slate-700/50 shadow-2xl shadow-indigo-500/5 focus-within:ring-2 focus-within:ring-indigo-500/50 focus-within:border-indigo-500 transition-all">
                <form id="prompt-form" class="flex gap-2" onsubmit="return handleSubmit(event)">
                    <textarea id="prompt-input"
                              rows="1"
                              class="flex-1 bg-transparent border-none text-slate-200 placeholder-slate-500 resize-none focus:ring-0 text-sm py-3 px-3"
                              placeholder="Describe your Python script..."
                              onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.form.requestSubmit()}"></textarea>
                    <button type="submit" id="send-btn"
                            class="px-5 bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-xl font-semibold transition-all shadow-lg shadow-indigo-600/20 flex items-center justify-center">
                        <svg class="icon w-5 h-5"><use href="#i-send"/></svg>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <!-- RIGHT PANEL: EDITOR & TERMINAL -->
    <aside class="w-[500px] glass-panel border-l border-slate-700/50 flex flex-col flex-shrink-0 z-20">
        
        <!-- Toolbar -->
        <div class="h-12 px-4 border-b border-white/5 flex items-center gap-2 bg-slate-900/50">
            <span class="text-xs font-bold text-slate-500 uppercase tracking-widest mr-auto flex items-center gap-2">
                <svg class="icon w-4 h-4 text-indigo-400"><use href="#i-code"/></svg> Editor
            </span>
            
            <div class="flex items-center gap-1 bg-slate-900 rounded-lg p-0.5 border border-slate-800">
                <button onclick="copyCode()" class="px-2.5 py-1.5 hover:bg-slate-800 rounded-md text-slate-400 hover:text-white transition-colors" title="Copy">
                    <svg class="icon w-3.5 h-3.5"><use href="#i-copy"/></svg>
                </button>
                <button onclick="downloadCode()" class="px-2.5 py-1.5 hover:bg-slate-800 rounded-md text-slate-400 hover:text-white transition-colors" title="Download">
                    <svg class="icon w-3.5 h-3.5"><use href="#i-download"/></svg>
                </button>
            </div>
            
            <div class="h-5 w-px bg-slate-800 mx-1"></div>

            <button onclick="lintCode()" class="px-3 py-1.5 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-500 hover:text-yellow-400 border border-yellow-500/20 rounded-lg text-xs font-semibold flex items-center gap-1.5 transition-all">
                <svg class="icon w-3.5 h-3.5"><use href="#i-check-circle"/></svg> Lint
            </button>
            <button onclick="securityScan()" class="px-3 py-1.5 bg-orange-500/10 hover:bg-orange-500/20 text-orange-500 hover:text-orange-400 border border-orange-500/20 rounded-lg text-xs font-semibold flex items-center gap-1.5 transition-all">
                <svg class="icon w-3.5 h-3.5"><use href="#i-shield"/></svg> Scan
            </button>

            <button onclick="runCode()" id="btn-run" class="ml-1 px-4 py-1.5 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg text-xs font-bold shadow-lg shadow-emerald-500/20 flex items-center gap-1.5 transition-all">
                <svg class="icon w-3.5 h-3.5"><use href="#i-play"/></svg> Run
            </button>
            <button onclick="stopCode()" id="btn-stop" disabled class="hidden px-4 py-1.5 bg-red-500/20 hover:bg-red-500/30 text-red-400 border border-red-500/50 rounded-lg text-xs font-bold transition-all items-center gap-1.5">
                <svg class="icon w-3.5 h-3.5"><use href="#i-stop"/></svg> Stop
            </button>
        </div>

        <!-- Monaco -->
        <div id="monaco-container" class="flex-1 min-h-[300px] bg-[#1e1e1e]"></div>

        <!-- Resizer -->
        <div class="resize-handle h-1 bg-slate-800 hover:bg-indigo-500/50 border-y border-slate-900/50 flex-shrink-0"></div>

        <!-- Terminal -->
        <div class="flex flex-col h-[240px] flex-shrink-0 bg-[#0d0d0d]">
             <div class="h-8 px-4 bg-slate-900 border-b border-slate-800 flex items-center justify-between">
                <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest flex items-center gap-2">
                    <svg class="icon w-3.5 h-3.5 text-emerald-500"><use href="#i-terminal"/></svg> Terminal Output
                </h3>
                <button onclick="clearTerminal()" class="text-[10px] text-slate-600 hover:text-slate-400 uppercase font-semibold">Clear</button>
            </div>
            
            <div id="log-output" class="flex-1 overflow-y-auto p-3 text-xs font-mono space-y-1">
                <div class="text-slate-700 italic">Waiting for execution...</div>
            </div>

            <!-- Stdin -->
            <div id="stdin-bar" class="hidden border-t border-slate-800 bg-slate-900 p-2 flex items-center gap-2">
                <span class="text-yellow-500 text-xs font-mono">➜</span>
                <input id="stdin-input" type="text"
                       class="flex-1 bg-black text-slate-200 text-xs font-mono px-3 py-1.5 rounded border border-slate-800 focus:border-yellow-500/50 focus:outline-none placeholder-slate-700"
                       placeholder="Enter input..."
                       onkeydown="if(event.key==='Enter') sendStdinInput();" />
                <button onclick="sendStdinInput()" class="px-3 py-1.5 bg-slate-800 hover:bg-slate-700 text-slate-300 text-xs font-medium rounded border border-slate-700">Send</button>
            </div>
        </div>

        <!-- Containers (Hidden by default) -->
        <div class="bg-slate-900 border-t border-slate-800">
             <button onclick="this.nextElementSibling.classList.toggle('hidden')"
                     class="w-full px-4 py-2 text-xs font-semibold text-slate-500 hover:text-slate-300 hover:bg-slate-800 flex items-center justify-between transition-colors">
                <span class="flex items-center gap-2">
                    <svg class="icon w-3.5 h-3.5"><use href="#i-box"/></svg> Active Containers
                </span>
                <svg class="icon w-3.5 h-3.5"><use href="#i-chevron-down"/></svg>
            </button>
            <div class="hidden px-2 pb-2 bg-slate-950/50" id="containers-panel"
                 hx-get="/api/containers/html" hx-trigger="load, every 15s" hx-swap="innerHTML">
                 <!-- HTMX -->
            </div>
        </div>
    </aside>

</div>

<!-- Monaco Loader -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/loader.js"></script>
<script>
// ══ Global State ══════════════════════════════════════════════════════
var editor = null;
var activeSessionId = '{{ active_session_id }}';
var isExecuting = false;
var modelsData = null;

// ══ Monaco Editor Setup ══════════════════════════════════════════════
require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs' } });
require(['vs/editor/editor.main'], function () {
    monaco.editor.defineTheme('custom-dark', {
        base: 'vs-dark',
        inherit: true,
        rules: [{ background: '1e1e1e' }],
        colors: { 'editor.background': '#1e1e1e' }
    });
    
    editor = monaco.editor.create(document.getElementById('monaco-container'), {
        value: {{ last_code|json|safe }},
        language: 'python',
        theme: 'custom-dark',
        minimap: { enabled: false },
        wordWrap: 'on',
        fontSize: 13,
        fontFamily: "'JetBrains Mono', monospace",
        lineNumbers: 'on',
        scrollBeyondLastLine: false,
        automaticLayout: true,
        padding: { top: 16, bottom: 16 },
        renderLineHighlight: 'none',
    });
    // Syntax highlight existing messages
    document.querySelectorAll('#chat-messages pre code').forEach(function(el) {
        if (window.hljs) hljs.highlightElement(el);
    });
});

// Resizable functionality
const resizer = document.querySelector('.resize-handle');
const terminal = resizer.nextElementSibling;
const container = document.getElementById('monaco-container');
let isResizing = false;

resizer.addEventListener('mousedown', (e) => {
    isResizing = true;
    document.body.style.cursor = 'row-resize';
});
document.addEventListener('mousemove', (e) => {
    if (!isResizing) return;
    const h = window.innerHeight - e.clientY;
    if (h > 100 && h < window.innerHeight - 200) {
        terminal.style.height = h + 'px';
    }
});
document.addEventListener('mouseup', () => {
    isResizing = false;
    document.body.style.cursor = '';
});


/* ══ Helper Functions (Toast, Formatting) ══ */
function showToast(msg, type='info') {
    var c = document.getElementById('toast-container');
    var d = document.createElement('div');
    var colors = {
        'success': 'bg-emerald-500/90 text-white',
        'error': 'bg-red-500/90 text-white',
        'warning': 'bg-amber-500/90 text-white',
        'info': 'bg-indigo-600/90 text-white'
    };
    d.className = `toast px-4 py-2 rounded-lg shadow-xl text-sm font-medium backdrop-blur-sm ${colors[type] || colors.info} flex items-center gap-2 pointer-events-auto`;
    d.innerHTML = msg;
    c.appendChild(d);
    setTimeout(() => d.remove(), 3000);
}

function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
}

function appendLog(type, msg) {
    var out = document.getElementById('log-output');
    if (out.children.length === 1 && out.children[0].classList.contains('italic')) out.innerHTML = '';
    
    var div = document.createElement('div');
    div.className = 'font-mono break-all leading-tight';
    
    if (type === 'stdout') div.className += ' text-slate-300';
    else if (type === 'stderr') div.className += ' text-red-400';
    else if (type === 'success') div.className += ' text-emerald-400 font-bold';
    else if (type === 'info') div.className += ' text-blue-400';
    else if (type === 'warning') div.className += ' text-amber-400';
    
    div.textContent = msg; // Text content safe
    out.appendChild(div);
    out.scrollTop = out.scrollHeight;
}

function clearTerminal() {
    document.getElementById('log-output').innerHTML = '<div class="text-slate-700 italic">Waiting for execution...</div>';
}

/* ══ Core Logic ══ */

function loadCodeInEditor(code) {
    if (editor) {
        editor.setValue(code);
        showToast('Code loaded to editor', 'info');
    }
}

function getEditorCode() { return editor ? editor.getValue() : ''; }

/* Chat */
async function handleSubmit(e) {
    e.preventDefault();
    var input = document.getElementById('prompt-input');
    var prompt = input.value.trim();
    if (!prompt) return false;

    var ph = document.getElementById('chat-placeholder');
    if (ph) ph.remove();

    appendMessage('user', prompt);
    input.value = '';
    input.style.height = 'auto'; // Reset height

    var typingId = showTypingIndicator(); // Function below
    var btn = document.getElementById('send-btn');
    btn.disabled = true;

    try {
        var params = new URLSearchParams();
        params.append('prompt', prompt);
        params.append('session_id', activeSessionId);

        var resp = await fetch('/api/generate', { method: 'POST', body: params });
        if (!resp.ok) throw new Error('Status ' + resp.status);
        var data = await resp.json();

        removeTypingIndicator(typingId);

        if (data.success) {
            appendMessage('assistant', data.code);
            loadCodeInEditor(data.code);
            htmx.trigger(document.getElementById('history-list'), 'historyRefresh');
            refreshSessionList();
        } else {
            appendMessage('error', data.error || 'Generation failed');
        }
    } catch (err) {
        removeTypingIndicator(typingId);
        appendMessage('error', 'Network error: ' + err.message);
    } finally {
        btn.disabled = false;
        input.focus();
    }
    return false;
}

function appendMessage(role, content) {
    var chat = document.getElementById('chat-messages');
    var div = document.createElement('div');

    if (role === 'user') {
        div.className = 'flex justify-end animate-slide-in';
        div.innerHTML = `<div class="chat-msg-user px-5 py-3.5 max-w-[70%] text-sm text-white font-medium shadow-lg leading-relaxed whitespace-pre-wrap">${escapeHtml(content)}</div>`;
    } else if (role === 'assistant') {
        div.className = 'flex justify-start animate-slide-in';
        div.innerHTML = `
            <div class="chat-msg-bot px-5 py-4 max-w-[85%] text-sm shadow-xl">
                <pre class="overflow-x-auto custom-scrollbar"><code class="language-python rounded-lg">${escapeHtml(content)}</code></pre>
                <div class="mt-3 pt-3 border-t border-white/5 flex justify-end">
                    <button onclick="loadCodeInEditor(this.closest('.chat-msg-bot').querySelector('code').textContent)"
                            class="text-xs text-indigo-400 hover:text-indigo-300 font-medium flex items-center gap-1.5 transition-colors">
                        Load in Editor <svg class="icon w-3.5 h-3.5"><use href="#i-arrow-right"/></svg>
                    </button>
                </div>
            </div>`;
        setTimeout(() => { if (window.hljs) hljs.highlightElement(div.querySelector('code')); }, 10);
    } else if (role === 'error') {
        div.className = 'flex justify-start animate-slide-in';
        div.innerHTML = `<div class="px-4 py-3 bg-red-500/10 border border-red-500/20 text-red-300 rounded-xl text-sm">${escapeHtml(content)}</div>`;
    }
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function showTypingIndicator() {
    var chat = document.getElementById('chat-messages');
    var id = 'typing-' + Date.now();
    var div = document.createElement('div');
    div.id = id;
    div.className = 'flex justify-start animate-slide-in';
    div.innerHTML = `
        <div class="chat-msg-bot px-4 py-3 flex gap-1.5 items-center">
            <div class="typing-dot w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
            <div class="typing-dot w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
            <div class="typing-dot w-1.5 h-1.5 bg-slate-400 rounded-full"></div>
        </div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return id;
}
function removeTypingIndicator(id) { var el = document.getElementById(id); if (el) el.remove(); }

/* Execution */
async function runCode() {
    var code = getEditorCode();
    if (!code.trim()) { showToast('Editor is empty', 'warning'); return; }

    isExecuting = true;
    document.getElementById('btn-run').classList.add('hidden');
    document.getElementById('btn-stop').classList.remove('hidden');
    document.getElementById('btn-stop').disabled = false;
    document.getElementById('stdin-bar').classList.remove('hidden');
    clearTerminal();
    appendLog('info', 'Compiling & starting execution...');

    try {
        var resp = await fetch('/api/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
        });
        if (!resp.ok) throw new Error(await resp.text());
    } catch (err) {
        appendLog('stderr', 'Failed to start: ' + err.message);
        executionFinished();
    }
}

async function stopCode() {
    try {
        await fetch('/api/execute/kill', { method: 'POST' });
        showToast('Kill signal sent', 'info');
    } catch (err) { showToast('Error stopping: ' + err.message, 'error'); }
}

function executionFinished() {
    isExecuting = false;
    document.getElementById('btn-run').classList.remove('hidden');
    document.getElementById('btn-stop').classList.add('hidden');
    document.getElementById('stdin-bar').classList.add('hidden');
}

async function sendStdinInput() {
    var input = document.getElementById('stdin-input');
    var text = input.value;
    input.value = '';
    input.focus();
    if (!isExecuting) { showToast('Not running', 'warning'); return; }

    try {
        await fetch('/api/execute/input', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ input: text }),
        });
    } catch (err) { appendLog('stderr', 'Input Error: ' + err.message); }
}

/* Lint & Security */
async function lintCode() {
    var code = getEditorCode();
    if (!code.trim()) return showToast('No code', 'warning');
    appendLog('info', 'Running Ruff lint check...');
    try {
        var resp = await fetch('/api/lint', { method: 'POST', body: JSON.stringify({code}), headers: {'Content-Type':'application/json'} });
        var data = await resp.json();
        if (data.passed) { appendLog('success', '✓ Lint Check Passed'); showToast('Lint Passed', 'success'); }
        else {
            appendLog('warning', '⚠ Lint Issues Found:');
            (data.diagnostics||[]).forEach(d => appendLog(d.severity==='error'?'stderr':'warning', `[${d.code}] ${d.message}`));
        }
    } catch (e) { appendLog('stderr', 'Lint Failed: ' + e.message); }
}

async function securityScan() {
    var code = getEditorCode();
    if (!code.trim()) return showToast('No code', 'warning');
    appendLog('info', 'Running Bandit security scan...');
    try {
        var resp = await fetch('/api/security', { method: 'POST', body: JSON.stringify({code}), headers: {'Content-Type':'application/json'} });
        var data = await resp.json();
        if (data.passed) { appendLog('success', '✓ Security Scan Passed'); showToast('Security Passed', 'success'); }
        else {
            appendLog('stderr', '⚠ Security Issues Found:');
            (data.diagnostics||[]).forEach(d => appendLog(d.severity==='HIGH'?'stderr':'warning', `[${d.severity}] ${d.message}`));
        }
    } catch (e) { appendLog('stderr', 'Scan Failed: ' + e.message); }
}

/* Copy/Download */
async function copyCode() {
    var code = getEditorCode();
    if (!code.trim()) return showToast('Nothing to copy', 'warning');
    await navigator.clipboard.writeText(code);
    showToast('Copied to clipboard', 'success');
}
function downloadCode() {
    var code = getEditorCode();
    if (!code.trim()) return showToast('Nothing to download', 'warning');
    var blob = new Blob([code], {type:'text/x-python'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `script_${new Date().toISOString().replace(/[:.]/g,'').slice(0,15)}.py`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

/* Sessions */
async function createSession() {
    await fetch('/api/sessions', {method:'POST'});
    setTimeout(() => { refreshSessionList(); window.location.reload(); }, 100); 
}
async function switchSession(id) {
    activeSessionId = id;
    await fetch('/api/sessions/'+id+'/active', {method:'PUT'});
    window.location.reload();
}
async function deleteSession(id) {
    if(!confirm('Delete this session?')) return;
    await fetch('/api/sessions/'+id, {method:'DELETE'});
    if(id === activeSessionId) window.location.reload();
    else refreshSessionList();
}
async function refreshSessionList() {
    var resp = await fetch('/api/sessions');
    var sessions = await resp.json();
    var list = document.getElementById('session-list');
    list.innerHTML = sessions.map(s => `
        <div class="group flex items-center rounded-lg ${s.id===activeSessionId ? 'bg-slate-800/80 text-white' : 'text-slate-400 hover:bg-slate-800/40 hover:text-slate-300'} transition-colors" data-session-id="${s.id}">
            <button class="flex-1 text-left px-3 py-2 text-xs truncate" onclick="switchSession('${s.id}')">${escapeHtml(s.name)}</button>
            <button class="opacity-0 group-hover:opacity-100 px-2 text-slate-500 hover:text-red-400 transition-opacity" onclick="deleteSession('${s.id}')">
                <svg class="icon w-3.5 h-3.5"><use href="#i-trash"/></svg>
            </button>
        </div>
    `).join('');
}

/* Settings Modal */
function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
async function saveSettings() {
    var s = {
        provider: document.getElementById('s-provider').value,
        api_url: document.getElementById('s-api-url').value,
        temperature: parseFloat(document.getElementById('s-temperature').value),
        max_tokens: parseInt(document.getElementById('s-max-tokens').value),
        execution_timeout_secs: parseInt(document.getElementById('s-timeout').value),
        use_docker: document.getElementById('s-docker').checked,
        use_venv: document.getElementById('s-venv').checked,
        use_linting: document.getElementById('s-linting').checked,
        use_security_check: document.getElementById('s-security').checked,
        auto_install_deps: document.getElementById('s-auto-deps').checked
    };
    try {
        await fetch('/api/settings', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(s) });
        showToast('Settings saved', 'success');
        closeSettings();
        setTimeout(() => window.location.reload(), 500);
    } catch(e) { showToast('Save failed', 'error'); }
}
async function loadSettings() {
    var resp = await fetch('/api/settings');
    var s = await resp.json();
    document.getElementById('s-provider').value = s.provider;
    document.getElementById('s-api-url').value = s.api_url || '';
    document.getElementById('s-temperature').value = s.temperature;
    document.getElementById('s-temp-val').innerText = s.temperature;
    document.getElementById('s-max-tokens').value = s.max_tokens;
    document.getElementById('s-timeout').value = s.execution_timeout_secs;
    document.getElementById('s-docker').checked = s.use_docker;
    document.getElementById('s-venv').checked = s.use_venv;
    document.getElementById('s-linting').checked = s.use_linting;
    document.getElementById('s-security').checked = s.use_security_check;
    document.getElementById('s-auto-deps').checked = s.auto_install_deps;
}

/* WebSocket */
var wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
var ws = new WebSocket(wsProtocol + '//' + window.location.host + '/api/logs');
ws.onmessage = function(event) {
    try {
        var msg = JSON.parse(event.data);
        if (msg.type === 'stdout') appendLog('stdout', msg.data);
        else if (msg.type === 'stderr') appendLog('stderr', msg.data);
        else if (msg.type === 'execution_started') {
            document.getElementById('log-output').innerHTML = '';
            appendLog('info', '--- Execution Started ---');
            isExecuting = true;
            document.getElementById('btn-run').classList.add('hidden');
            document.getElementById('btn-stop').classList.remove('hidden');
        } else if (msg.type === 'execution_finished') {
            appendLog('info', `--- Finished (Exit Code: ${msg.exit_code}) ---`);
            executionFinished();
            if(msg.exit_code === 0) showToast('Execution finished', 'success');
            else showToast('Execution failed', 'error');
            htmx.trigger(document.getElementById('stats-panel'), 'load'); 
        } else if (msg.type === 'code_generated') {
             appendMessage('assistant', msg.code);
             loadCodeInEditor(msg.code);
             htmx.trigger(document.getElementById('history-list'), 'historyRefresh');
        }
    } catch(e) {}
};

// Init
document.getElementById('s-temperature').addEventListener('input', e => document.getElementById('s-temp-val').innerText = e.target.value);
loadSettings();
</script>
</body>
</html>
